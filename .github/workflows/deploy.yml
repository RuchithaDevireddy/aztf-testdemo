name: Deploy .NET App to Azure VM

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore ./YourProject.csproj

      - name: Build
        run: dotnet build --configuration Release ./YourProject.csproj

      - name: Publish
        run: dotnet publish --configuration Release -o publish/ ./YourProject.csproj

      - name: Install SSH Client
        run: sudo apt-get install -y sshpass openssh-client

      - name: Copy files to VM (SCP)
        run: |
          echo "${{ secrets.VM_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem

          scp -o StrictHostKeyChecking=no -i private_key.pem -r publish/* \
            ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }}:/var/www/myapp/

      - name: Restart application on VM
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem \
            ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} << 'EOF'

            sudo systemctl daemon-reload
            sudo systemctl restart myapp
            sudo systemctl status myapp --no-pager

          EOF
